import { ZkConnectResponse } from "../src";
import { zkConnectResponseMock } from "./mocks";
import { ethers } from "ethers";

describe("PwsVerifier", () => {
  let pws: Pws;
  let zkConnectResponse: ZkConnectResponse;
  let serviceName: string;
  let targetGroup: TargetGroup;

  beforeAll(() => {
    targetGroup = { groupId: "0x7c26c2916ebb787af751786923dc67e0" };
    serviceName = "my-service-name";
    zkConnectResponse = zkConnectResponseMock;
    const _provider = new ethers.providers.JsonRpcProvider("https://rpc.ankr.com/eth_goerli", 5);
    pws = new Pws({
      appId: "0xf68985adfc209fafebfb1a956913e7fa",
      opts: {
        provider: _provider,
        verifier: {
          hydraS1: {
            commitmentMapperRegistryAddress: "0x0844662f25817B735BC9B6d9D11995F1A6c4dCB1",
            availableRootsRegistryAddress: "0xdDa4c8d2933dAA21Aac75B88fF59725725ba813F",
          },
        },
      },
    });
  });

  describe("Pws server", () => {
    it("Should verify", async () => {
      const isVerified = await pws.verify({ proof: zkConnectResponse, targetGroup, serviceName });
      expect(isVerified).toEqual({
        proofId: "6309534761324871539338983689708099593503383107933868334769739103072693501287",
        proofIds: ["6309534761324871539338983689708099593503383107933868334769739103072693501287"],
        provedMembership: {
          additionalProperties: null,
          groupId: "0x7c26c2916ebb787af751786923dc67e0",
          proof: {
            a: [
              "6630233505228905964309528915871249286398907846855557462517181178518745564092",
              "19549995083857314378538770173523258324234368172828745796667166322016072774452",
            ],
            b: [
              [
                "4084015672304671825448722290760770548582713701533777752447127776633038053227",
                "9712150380049602635466226213450105106817437199522529584826057256473031420519",
              ],
              [
                "8273113926731676338753859808893529640189267349609687633858956896229067595633",
                "20805053814979407493332647015840579923606603497102069825600287091930803084394",
              ],
            ],
            c: [
              "14192138749440300886802197575178987896074035166545631610472483391984354970216",
              "11843632343011935299922669966918179077386026572478347808708157822116397256343",
            ],
            input: [
              "5329168",
              "0",
              "13694022827327392162307984190030265167779463290556240196471372692464680348124",
              "19644872369728090911561801126138671047740635834672788827973600491256736746205",
              "18284478552824756948592626668826655825533404155480463543923937690555967644745",
              "10863215339702931304932908503091022559733650740910400023060133858821451798433",
              "6309534761324871539338983689708099593503383107933868334769739103072693501287",
              "1",
              "12378790528753077450573087649871528477137636995109599554365037893763911909374",
              "0",
            ],
          },
          proofId: "6309534761324871539338983689708099593503383107933868334769739103072693501287",
          provingScheme: "hydraS1",
          timestamp: "latest",
          value: 1,
          version: "1.0.7",
        },
        provedMemberships: [
          {
            additionalProperties: null,
            groupId: "0x7c26c2916ebb787af751786923dc67e0",
            proof: {
              a: [
                "6630233505228905964309528915871249286398907846855557462517181178518745564092",
                "19549995083857314378538770173523258324234368172828745796667166322016072774452",
              ],
              b: [
                [
                  "4084015672304671825448722290760770548582713701533777752447127776633038053227",
                  "9712150380049602635466226213450105106817437199522529584826057256473031420519",
                ],
                [
                  "8273113926731676338753859808893529640189267349609687633858956896229067595633",
                  "20805053814979407493332647015840579923606603497102069825600287091930803084394",
                ],
              ],
              c: [
                "14192138749440300886802197575178987896074035166545631610472483391984354970216",
                "11843632343011935299922669966918179077386026572478347808708157822116397256343",
              ],
              input: [
                "5329168",
                "0",
                "13694022827327392162307984190030265167779463290556240196471372692464680348124",
                "19644872369728090911561801126138671047740635834672788827973600491256736746205",
                "18284478552824756948592626668826655825533404155480463543923937690555967644745",
                "10863215339702931304932908503091022559733650740910400023060133858821451798433",
                "6309534761324871539338983689708099593503383107933868334769739103072693501287",
                "1",
                "12378790528753077450573087649871528477137636995109599554365037893763911909374",
                "0",
              ],
            },
            proofId: "6309534761324871539338983689708099593503383107933868334769739103072693501287",
            provingScheme: "hydraS1",
            timestamp: "latest",
            value: 1,
            version: "1.0.7",
          },
        ],
      });
    });
  });
});
